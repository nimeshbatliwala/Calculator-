<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Jaguar V12 Platinum Ultra</title>
    <style>
        :root { --radius: 12px; --blur: 0px; }

        /* --- THEMES 0-31 --- */
        body.t-0 { --bg: #050a10; --panel: #0f172a; --key: #1e293b; --accent: #38bdf8; --text: #f8fafc; --shadow: #000; --light: #334155; --disp: #020617; }
        body.t-1 { --bg: #f1f5f9; --panel: #ffffff; --key: #e2e8f0; --accent: #2563eb; --text: #0f172a; --shadow: #94a3b8; --light: #cbd5e1; --disp: #1e293b; }
        body.t-2 { --bg: linear-gradient(135deg, #f43f5e, #fb7185); --panel: #fff; --key: #fff1f2; --accent: #e11d48; --text: #881337; --shadow: #fda4af; --light: #fff; --disp: #4c0519; }
        body.t-3 { --bg: #2e1065; --panel: #4c1d95; --key: #5b21b6; --accent: #a78bfa; --text: #fff; --shadow: #000; --light: #6d28d9; --disp: #1e1b4b; }
        body.t-4 { --bg: #451a03; --panel: #78350f; --key: #92400e; --accent: #facc15; --text: #fff; --shadow: #000; --light: #b45309; --disp: #000000; }
        body.t-5 { --bg: #022c22; --panel: #064e3b; --key: #065f46; --accent: #4ade80; --text: #fff; --shadow: #000; --light: #0f766e; --disp: #000000; }
        body.t-6 { --bg: #1e3a8a; --panel: #1e40af; --key: #1d4ed8; --accent: #60a5fa; --text: #fff; --shadow: #000; --light: #2563eb; --disp: #172554; }
        body.t-7 { --bg: #000; --panel: #111; --key: #222; --accent: #00ffcc; --text: #fff; --shadow: #000; --light: #333; --disp: #0a0a0a; }
        body.t-8 { --bg: #faf5ff; --panel: #fff; --key: #f3e8ff; --accent: #7e22ce; --text: #3b0764; --shadow: #d8b4fe; --light: #e9d5ff; --disp: #2e1065; }
        body.t-9 { --bg: #fff7ed; --panel: #fff; --key: #ffedd5; --accent: #ea580c; --text: #7c2d12; --shadow: #fed7aa; --light: #fdba74; --disp: #431407; }
        body.t-11 { --bg: linear-gradient(45deg, #00dbde, #fc00ff); --panel: rgba(0,0,0,0.6); --key: rgba(255,255,255,0.1); --accent: #fff; --text: #fff; --shadow: #000; --light: #444; --disp: #000; }
        body.t-12 { --bg: linear-gradient(to right, #11998e, #38ef7d); --panel: #002d26; --key: #004d40; --accent: #ccff00; --text: #fff; --shadow: #000; --light: #00695c; --disp: #001a14; }
        body.t-13 { --bg: #000000; --panel: #1a1a1a; --key: #333; --accent: #ff0000; --text: #ff4d4d; --shadow: #ff0000; --light: #444; --disp: #000; }
        body.t-14 { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --panel: #ffffff; --key: #f0f0f0; --accent: #667eea; --text: #4a148c; --shadow: #764ba2; --light: #e0e0e0; --disp: #2a0a4d; }
        body.t-15 { --bg: #ffecd2; --panel: #fcb69f; --key: #ff9a9e; --accent: #fff; --text: #fff; --shadow: #333; --light: #fbc2eb; --disp: #4a1111; }
        body.t-16 { --bg: #090909; --panel: #121212; --key: #1f1f1f; --accent: #bb86fc; --text: #e0e0e0; --shadow: #000; --light: #333; --disp: #121212; }
        body.t-17 { --bg: linear-gradient(to right, #ff5f6d, #ffc371); --panel: #fff; --key: #fff5f0; --accent: #ff5f6d; --text: #7c2d12; --shadow: #ffc371; --light: #ffedd5; --disp: #3e1205; }
        body.t-18 { --bg: #232526; --panel: #414345; --key: #333; --accent: #00e5ff; --text: #fff; --shadow: #000; --light: #555; --disp: #1a1a1a; }
        body.t-19 { --bg: #134e4a; --panel: #0f766e; --key: #115e59; --accent: #5eead4; --text: #fff; --shadow: #042f2e; --light: #14b8a6; --disp: #042f2e; }
        body.t-21 { --bg: #000; --panel: #000; --key: #111; --accent: #ff00ff; --text: #00ffff; --light: #222; --disp: #000; }
        body.t-22 { --bg: #f0fdf4; --panel: #fff; --key: #dcfce7; --accent: #15803d; --text: #14532d; --light: #bbf7d0; --disp: #064e3b; }
        body.t-23 { --bg: linear-gradient(to bottom, #0ea5e9, #38bdf8); --panel: #fff; --key: #e0f2fe; --accent: #0369a1; --text: #0c4a6e; --disp: #082f49; }
        body.t-24 { --bg: #450a0a; --panel: #7f1d1d; --key: #991b1b; --accent: #f87171; --text: #fff; --disp: #000; }
        body.t-25 { --bg: #1f2937; --panel: #374151; --key: #4b5563; --accent: #d1d5db; --text: #fff; --disp: #111827; }
        body.t-31 { --bg: #000; --panel: #1a1a1a; --key: #222; --accent: #ffffff; --text: #fff; --shadow: #000; --light: #444; --disp: #000; }

        /* --- GLASS THEMES --- */
        body.t-26 { --bg: linear-gradient(45deg, #00dbde, #fc00ff); --panel: rgba(255,255,255,0.1); --key: rgba(255,255,255,0.1); --accent: #fff; --text: #fff; --disp: rgba(0,0,0,0.5); --blur: 25px; --light: rgba(255,255,255,0.2); }
        body.t-27 { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --panel: rgba(255,255,255,0.1); --key: rgba(255,255,255,0.1); --accent: #00e5ff; --text: #fff; --disp: rgba(0,0,0,0.4); --blur: 20px; }
        body.t-28 { --bg: linear-gradient(to right, #f83600, #f9d423); --panel: rgba(255,255,255,0.15); --key: rgba(255,255,255,0.1); --accent: #fff; --text: #fff; --disp: rgba(0,0,0,0.6); --blur: 30px; }
        body.t-29 { --bg: linear-gradient(to right, #00b09b, #96c93d); --panel: rgba(255,255,255,0.1); --key: rgba(255,255,255,0.1); --accent: #fff; --text: #fff; --disp: rgba(0,0,0,0.5); --blur: 20px; }
        body.t-30 { --bg: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); --panel: rgba(255,255,255,0.1); --key: rgba(255,255,255,0.1); --accent: #fff; --text: #fff; --disp: rgba(0,0,0,0.4); --blur: 25px; }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { width: 100vw; height: 100vh; overflow: hidden; background: var(--bg); background-size: cover; font-family: -apple-system, sans-serif; position: fixed; transition: 0.5s; }
        
        #main-ui { width: 100vw; height: 100vh; display: none; align-items: center; justify-content: center; padding: 15px; }
        #tablet { 
            width: 100%; height: 100%; max-width: 440px; background: var(--panel); 
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border-radius: 28px; display: flex; flex-direction: column; padding: 15px; 
            box-shadow: 0 25px 60px var(--shadow); border: 1px solid var(--light); position: relative; 
        }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 8px; }
        #garage-trigger { color: var(--accent); font-size: 10px; letter-spacing: 2px; cursor: pointer; font-weight: 800; text-transform: uppercase; text-shadow: 0 0 5px var(--accent); }
        
        .key.k-eq.mic-active { 
            background: #ff4444 !important; 
            box-shadow: 0 0 25px #ff4444 !important; 
            transform: scale(0.95);
        }

        #display { 
            width: 100%; height: 130px; margin-bottom: 15px; background: var(--disp); border-radius: 20px; padding: 15px 22px; 
            display: flex; flex-direction: column; justify-content: center; align-items: flex-end; cursor: pointer; 
            border: 2px solid var(--accent); 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 15px var(--accent); 
            overflow: hidden; transition: 0.3s; position: relative; z-index: 10;
        }
        #display::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at center, transparent 40%, var(--accent) 150%); opacity: 0.15; pointer-events: none; }

        #layer-eq { font-size: 1.25rem; color: #fff; opacity: 0.95; width: 100%; overflow-x: auto; white-space: nowrap; text-align: right; margin-bottom: 4px; font-family: 'Courier New', monospace; font-weight: bold; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
        #layer-ans { font-size: 2.3rem; color: var(--accent); font-weight: 700; width: 100%; text-align: right; overflow-x: auto; white-space: nowrap; text-shadow: 0 0 15px var(--accent); }

        .keypad { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .key { 
            background: var(--key); border: 1px solid var(--light); border-radius: 14px; font-size: 1.4rem; color: var(--text); 
            display: flex; align-items: center; justify-content: center; font-weight: 600; transition: 0.15s; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        .key.pressed, .key:active { transform: translateY(2px); filter: brightness(1.3); }
        .key.k-eq { background: var(--accent) !important; color: #000 !important; border: 2px solid rgba(255,255,255,0.4) !important; box-shadow: 0 0 20px var(--accent) !important; font-size: 1.8rem; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); visibility: hidden; opacity: 0; z-index: 5000; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .overlay.active { visibility: visible; opacity: 1; }
        .modal { width: 92%; max-height: 85vh; background: linear-gradient(135deg, #1a1c2c, #4a1942); border-radius: 25px; padding: 25px; color: #fff; display: flex; flex-direction: column; border: 2px solid #00e5ff; }
        .row { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; }
        #hist-scroll { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 10px; margin-top: 10px; }
        
        #splash { position: fixed; inset: 0; z-index: 20000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        select, .tog-btn { background: #fff; border: none; padding: 8px; border-radius: 8px; font-weight: bold; width: 130px; color: #000; }
    </style>
</head>
<body class="t-0">

<div id="splash">
    <div style="font-size: 32px; letter-spacing: 10px; color: #00e5ff; margin-bottom: 40px; font-weight: 900; text-shadow: 0 0 20px #00e5ff;">JAGUAR V12</div>
    <button id="ignition-btn" style="padding: 20px 80px; border-radius: 10px; border: 3px solid #00e5ff; background: transparent; color: #00e5ff; font-weight: 900; font-size: 20px; cursor: pointer;">IGNITION</button>
</div>

<div id="main-ui">
    <div id="tablet">
        <div class="top-bar">
            <div id="garage-trigger" onclick="openGarage()">JAGUAR GARAGE CORE</div>
            <div style="color:var(--accent); font-size:9px; opacity:0.6;">V12 ULTRA</div>
        </div>
        <div id="display" onclick="handleDisplayTap(event)">
            <div id="layer-eq"></div>
            <div id="layer-ans">0</div>
        </div>
        <div class="keypad" id="pad">
            <button class="key" data-val="AC">AC</button>
            <button class="key" data-val="DEL">DEL</button>
            <button class="key" data-val="%">%</button>
            <button class="key" data-val="/">Ã·</button>
            <button class="key" data-val="7">7</button><button class="key" data-val="8">8</button><button class="key" data-val="9">9</button>
            <button class="key" data-val="*">Ã—</button>
            <button class="key" data-val="4">4</button><button class="key" data-val="5">5</button><button class="key" data-val="6">6</button>
            <button class="key" data-val="-">âˆ’</button>
            <button class="key" data-val="1">1</button><button class="key" data-val="2">2</button><button class="key" data-val="3">3</button>
            <button class="key" data-val="+">+</button>
            <button class="key" data-val="0">0</button><button class="key" data-val="00">00</button><button class="key" data-val=".">.</button>
            <button class="key k-eq" id="eq-btn" data-val="=">ðŸŽ¤</button>
        </div>
    </div>
</div>

<div id="garage-overlay" class="overlay" onclick="openGarage()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>SYSTEM GARAGE</h2>
        <div class="row" style="background: #3b82f6;">FULLSCREEN <button class="tog-btn" onclick="forceFS()">ACTIVATE</button></div>
        <div class="row" style="background: #a855f7;">VOICE ARTIST <select id="artist-sel" onchange="setCfg('art', this.value)">
            <option value="amitabh">Amitabh B.</option>
            <option value="lady">Voice</option>
        </select></div>
        <div class="row" style="background: #ec4899;">LANGUAGE <button class="tog-btn" onclick="tog('isG')" id="l-btn">ENG</button></div>
        <div class="row" style="background: #10b981;">SOUND MASTER <button class="tog-btn" onclick="tog('s')" id="v-btn">ON</button></div>
        <div class="row" style="background: #f59e0b;">BEEP PROF <select id="b-sel" onchange="setCfg('bp', this.value)"></select></div>
        <div class="row" style="background: #6366f1;">PIANO PROF <select id="p-sel" onchange="setCfg('pp', this.value)"></select></div>
        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <div style="font-weight:900; font-size:11px; color:#00e5ff;">HISTORY (MAX 10)</div>
            <button onclick="clearHist()" style="border:none; color:#ff4444; font-size:11px; background:none; font-weight:900;">CLEAR</button>
        </div>
        <div id="hist-scroll"></div>
        <button class="tog-btn" style="width:100%; margin-top:15px; background:#fff; color:#000; height:45px;" onclick="openGarage()">EXIT GARAGE</button>
    </div>
</div>

<script>
    let expr = "", liveAns = "0", isRes = false, lastFullEq = "";
    const aCtx = new (window.AudioContext || window.webkitAudioContext)();
    const gMap = {'0':'à«¦','1':'à«§','2':'à«¨','3':'à«©','4':'à«ª','5':'à««','6':'à«¬','7':'à«­','8':'à«®','9':'à«¯','00':'à«¦à«¦','/':'Ã·','*':'Ã—','-':'âˆ’'};
    
    const opsSpeech = {
        'en': {'+':'plus','-':'minus','*':'multiplied by','/':'divided by','%':'percent'},
        'gu': {'+':'àªµàª¤à«àª¤àª¾','-':'àª“àª›àª¾','*':'àª—à«àª£à«àª¯àª¾','/':'àª­àª¾àª—à«àª¯àª¾','%':'àªŸàª•àª¾'}
    };

    let cfg = { 
        tIdx: parseInt(localStorage.getItem('v12_tIdx')) || 0, 
        isG: localStorage.getItem('v12_isG') === 'true',
        art: localStorage.getItem('v12_art') || "amitabh",
        bp: localStorage.getItem('v12_bp') || "b1",
        pp: localStorage.getItem('v12_pp') || "p1",
        s: localStorage.getItem('v12_s') !== 'false'
    };

    const beeps = [{n:"Mute",f:0},{n:"Soft Tap",f:800,t:'sine',d:0.08,g:0.3},{n:"Silk Touch",f:1200,t:'sine',d:0.04,g:0.2},{n:"Digital Click",f:2000,t:'square',d:0.02,g:0.1},{n:"Low Pulse",f:150,t:'triangle',d:0.12,g:0.4},{n:"Bubble Pop",f:600,t:'sine',d:0.15,g:0.4},{n:"Feather",f:1800,t:'sine',d:0.06,g:0.2},{n:"Glass Ting",f:2800,t:'sine',d:0.08,g:0.3},{n:"Sport Beep",f:1100,t:'sawtooth',d:0.04,g:0.1},{n:"Eco Click",f:450,t:'sine',d:0.06,g:0.3}];
    const pianos = [{n:"Mute Piano",f:0},{n:"Grand Piano",t:'triangle',d:1.5,g:0.7},{n:"Studio One",t:'sine',d:0.6,g:0.9},{n:"Mellow Gold",t:'sine',d:1.2,g:0.5},{n:"Honky Tonk",t:'sawtooth',d:0.7,g:0.2},{n:"Electric Sky",t:'square',d:1.0,g:0.1},{n:"Classic 88",t:'triangle',d:1.4,g:0.4},{n:"Toy Box",t:'sine',d:0.3,g:0.8},{n:"Bright Key",t:'sine',d:0.5,g:1.0},{n:"Dark Night",t:'triangle',d:2.5,g:0.3},{n:"Dream State",t:'sine',d:3.0,g:0.2},{n:"Space Echo",t:'sine',d:2.8,g:0.4},{n:"Jazz Club",t:'sawtooth',d:0.9,g:0.1},{n:"Royal Felt",t:'triangle',d:1.8,g:0.5},{n:"Ambient Sky",t:'sine',d:2.2,g:0.3}];
    const pFreqs = {'AC':261,'DEL':293,'%':329,'/':349,'7':392,'8':440,'9':493,'*':523,'4':587,'5':659,'6':698,'-':783,'1':880,'2':987,'3':1046,'+':1174,'0':1318,'.':1396,'=':1567,'00':1000};

    let recognition;
    let isVoiceInput = false;
    let micTimer;
    let isMicRunning = false;

    if (window.SpeechRecognition || window.webkitSpeechRecognition) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let currentTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                currentTranscript += event.results[i][0].transcript;
            }
            if (currentTranscript !== "") {
                let result = currentTranscript.toLowerCase();
                // UNIVERSAL MAP - ALWAYS APPLIED
                const map = {
                    'plus':'+','àªµàª¤à«àª¤àª¾':'+','àªªà«àª²àª¸':'+',
                    'minus':'-','àª“àª›àª¾':'-','àª®àª¾àªˆàª¨àª¸':'-',
                    'into':'*','àª—à«àª£à«àª¯àª¾':'*','àª—à«àª£àª¾àª•àª¾àª°':'*','àª‡àª¨àªŸà«':'*',
                    'divide':'/','àª­àª¾àª—à«àª¯àª¾':'/','àª­àª¾àª—àª¾àª•àª¾àª°':'/','àª¡àª¿àªµàª¾àªˆàª¡':'/',
                    'percent':'%','àªŸàª•àª¾':'%','àªªàª°à«àª¸àª¨à«àªŸ':'%'
                };
                Object.keys(map).forEach(key => {
                    result = result.replace(new RegExp(key, 'g'), map[key]);
                });
                let clean = result.replace(/[^0-9+\-*/.%]/g, '');
                if(clean) { expr = clean; calc(); updateUI(); }
            }
        };
    }

    const eqBtn = document.getElementById('eq-btn');

    function startMic() {
        if(!recognition) return;
        isMicRunning = true; isVoiceInput = true;
        expr = ""; liveAns = "0"; isRes = false; lastFullEq = "";
        
        // FORCING MULTI-LANGUAGE ENGINE TO DETECT BOTH AT ONCE
        recognition.lang = 'gu-IN,en-IN'; 
        
        recognition.start();
        eqBtn.classList.add('mic-active');
        updateUI();
    }

    function stopMic() {
        if(!isMicRunning) return;
        isMicRunning = false; recognition.stop();
        eqBtn.classList.remove('mic-active');
        setTimeout(() => {
            if(expr !== "" && !isRes) {
                lastFullEq = expr + "=" + liveAns;
                speak(cfg.isG ? `javab che ${liveAns}` : `Result is ${liveAns}`);
                expr = liveAns; isRes = true;
                updateUI(); isVoiceInput = false;
            }
        }, 600);
    }

    eqBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        micTimer = setTimeout(startMic, 500);
    });

    eqBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        clearTimeout(micTimer);
        if (isMicRunning) stopMic(); else handleInput('=');
    });

    eqBtn.addEventListener('mousedown', () => micTimer = setTimeout(startMic, 500));
    eqBtn.addEventListener('mouseup', () => {
        clearTimeout(micTimer);
        if (isMicRunning) stopMic(); else handleInput('=');
    });

    function forceFS() {
        const de = document.documentElement;
        if (de.requestFullscreen) de.requestFullscreen();
        else if (de.webkitRequestFullscreen) de.webkitRequestFullscreen();
    }

    document.getElementById('ignition-btn').onclick = () => {
        if (aCtx.state === 'suspended') aCtx.resume();
        forceFS();
        document.getElementById('splash').style.display='none'; 
        document.getElementById('main-ui').style.display='flex';
        updateMenu(); applyUI();
    };

    function handleDisplayTap(e) {
        const rect = e.currentTarget.getBoundingClientRect();
        cfg.tIdx = (e.clientX - rect.left > rect.width / 2) ? (cfg.tIdx + 1) % 32 : (cfg.tIdx - 1 + 32) % 32;
        localStorage.setItem('v12_tIdx', cfg.tIdx); applyUI();
    }

    function speak(text) {
        if(!cfg.s) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = cfg.isG ? 'gu-IN' : 'en-IN';
        u.pitch = cfg.isG ? 1.0 : (cfg.art === 'amitabh' ? 0.45 : 1.1);
        u.rate = 0.85; 
        window.speechSynthesis.speak(u);
    }

    function processSpeech(v) {
        const lang = cfg.isG ? 'gu' : 'en';
        if(opsSpeech[lang][v]) { speak(opsSpeech[lang][v]); return; }
        let numberStream = expr.split(/[\+\-\*\/\%]/);
        let currentNum = numberStream[numberStream.length - 1];
        if (currentNum !== "" && !isNaN(currentNum)) { speak(currentNum); }
    }

    function handleInput(v) {
        if (v === '=') {
            if(liveAns !== "Error" && expr !== "") {
                lastFullEq = expr + "=" + liveAns;
                if(!isVoiceInput) addLog(lastFullEq);
                speak(cfg.isG ? `javab che ${liveAns}` : `Result is ${liveAns}`);
                expr = liveAns; isRes = true;
            }
        } else {
            const b = beeps[parseInt(cfg.bp.slice(1))] || beeps[0];
            const p = pianos[parseInt(cfg.pp.slice(1))] || pianos[0];
            if(b.f > 0) genSound(b.f, b.t, b.d, b.g);
            if(pFreqs[v] && cfg.pp !== "p0") genSound(pFreqs[v], p.t, p.d, p.g);

            const ops = ['+','-','*','/','%'];
            if (v === 'AC') { expr = ""; liveAns = "0"; isRes = false; lastFullEq = ""; speak(cfg.isG ? "àª¸àª¾àª« àª•àª°à«‹" : "Clear"); } 
            else if (v === 'DEL') { if(isRes) { expr = ""; isRes = false; } else { expr = expr.slice(0, -1); } calc(); } 
            else {
                if (isRes) { if(!isNaN(v) || v === '00' || v === '.') expr = ""; isRes = false; }
                if (ops.includes(v) && ops.includes(expr.slice(-1))) { expr = expr.slice(0, -1) + v; } else { expr += v; }
                calc(); processSpeech(v);
            }
        }
        updateUI();
    }

    function calc() {
        if(expr === "") { liveAns = "0"; return; }
        try {
            let temp = expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/âˆ’/g,'-');
            const pcRegex = /^(\d+\.?\d*)([\+\-\*\/])(\d+\.?\d*)%$/;
            if (pcRegex.test(temp)) {
                const match = temp.match(pcRegex);
                let v1 = parseFloat(match[1]), op = match[2], v2 = parseFloat(match[3]);
                if (op === '+') liveAns = (v1 + (v1 * v2 / 100)).toString();
                else if (op === '-') liveAns = (v1 - (v1 * v2 / 100)).toString();
                else if (op === '*') liveAns = (v1 * v2 / 100).toString();
                else if (op === '/') liveAns = (v1 / (v2 / 100)).toString();
                return;
            }
            let res = eval(temp.replace(/[+\-*/]$/, ""));
            liveAns = (res !== undefined) ? Number(res.toFixed(10)).toString() : "0";
        } catch { liveAns = "Error"; }
    }

    function updateUI() {
        const conv = (s) => cfg.isG ? s.toString().split('').map(x => gMap[x] || x).join('') : s;
        const eqDisp = document.getElementById('layer-eq');
        const ansDisp = document.getElementById('layer-ans');
        document.querySelectorAll('.key').forEach(k => {
            const val = k.dataset.val;
            if(val !== "=") k.innerText = cfg.isG ? (gMap[val] || val) : val;
        });
        if(isRes) { eqDisp.innerText = conv(lastFullEq); ansDisp.innerText = conv(expr); } 
        else { eqDisp.innerText = conv(expr); ansDisp.innerText = conv(liveAns); }
    }

    function genSound(f, t, d, gVal) {
        let o = aCtx.createOscillator(), g = aCtx.createGain();
        o.type = t; o.frequency.value = f;
        g.gain.setValueAtTime(0.3 * gVal, aCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, aCtx.currentTime + d);
        o.connect(g); g.connect(aCtx.destination); o.start(); o.stop(aCtx.currentTime + d);
    }

    function addLog(item) {
        let h = JSON.parse(localStorage.getItem('v12_logs') || "[]");
        h.unshift(item); if(h.length > 10) h.pop();
        localStorage.setItem('v12_logs', JSON.stringify(h));
    }
    function clearHist() { localStorage.setItem('v12_logs', "[]"); renderHist(); }
    function openGarage() { document.getElementById('garage-overlay').classList.toggle('active'); renderHist(); }
    function renderHist() {
        const h = JSON.parse(localStorage.getItem('v12_logs') || "[]");
        document.getElementById('hist-scroll').innerHTML = h.map((i, idx) => `<div class="hist-item"><span>${idx + 1}. ${i}</span></div>`).join('') || "EMPTY";
    }
    function setCfg(k, v) { cfg[k] = v; localStorage.setItem('v12_'+k, v); }
    function tog(k) { cfg[k] = !cfg[k]; localStorage.setItem('v12_'+k, cfg[k]); updateMenu(); }
    function updateMenu() {
        document.getElementById('l-btn').innerText = cfg.isG ? "GUJARATI" : "ENGLISH";
        document.getElementById('v-btn').innerText = cfg.s ? "ON" : "OFF";
        document.getElementById('artist-sel').value = cfg.art;
        document.getElementById('b-sel').innerHTML = beeps.map((b,i)=>`<option value="b${i}">${b.n}</option>`).join('');
        document.getElementById('p-sel').innerHTML = pianos.map((p,i)=>`<option value="p${i}">${p.n}</option>`).join('');
        document.getElementById('b-sel').value = cfg.bp; document.getElementById('p-sel').value = cfg.pp;
        updateUI();
    }
    function applyUI() { document.body.className = `t-${cfg.tIdx}`; }

    document.getElementById('pad').addEventListener('touchstart', e => {
        if(e.target.dataset.val && e.target.id !== "eq-btn") {
            e.preventDefault();
            e.target.classList.add('pressed');
            setTimeout(() => e.target.classList.remove('pressed'), 100);
            isVoiceInput = false;
            handleInput(e.target.dataset.val);
        }
    }, {passive: false});
</script>
</body>
</html>
